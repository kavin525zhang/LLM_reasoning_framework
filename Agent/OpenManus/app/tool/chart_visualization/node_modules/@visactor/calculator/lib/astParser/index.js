"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryDataset = void 0;
const node_sql_parser_1 = __importDefault(require("node-sql-parser"));
const query_1 = require("../query");
const utils_1 = require("./utils");
const parseSqlAST_1 = require("./parseSqlAST");
const vutils_1 = require("@visactor/vutils");
const queryDataset = async (sql, fieldInfo, sourceDataset) => {
    const { validStr, replaceMap } = (0, utils_1.preprocessSQL)(sql, fieldInfo);
    const parser = new node_sql_parser_1.default.Parser();
    const ast = parser.astify(validStr);
    const queryObject = (0, parseSqlAST_1.parseSqlAST)(((0, vutils_1.isArray)(ast) ? ast[0] : ast), sourceDataset, fieldInfo, replaceMap);
    const dataset = (0, query_1.query)(queryObject);
    const fieldInfoNew = (0, utils_1.parseRespondField)(fieldInfo, dataset, replaceMap);
    return {
        dataset: dataset.length === 0 ? sourceDataset : dataset,
        fieldInfo: dataset.length === 0 ? fieldInfo : fieldInfoNew
    };
};
exports.queryDataset = queryDataset;
