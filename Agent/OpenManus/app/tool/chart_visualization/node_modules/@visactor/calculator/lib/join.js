"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.crossJoin = exports.innerJoin = exports.rightJoin = exports.leftJoin = exports.join = void 0;
const types_1 = require("./types");
const pipes_1 = require("./pipes");
const join = ({ type, left, right, using }) => {
    const joinMethods = {
        [types_1.JoinType.Left]: exports.leftJoin,
        [types_1.JoinType.Right]: exports.rightJoin,
        [types_1.JoinType.Inner]: exports.innerJoin,
        [types_1.JoinType.Cross]: exports.crossJoin,
    };
    return joinMethods[type]({ left, right, using });
};
exports.join = join;
const leftJoin = ({ left, right, using }) => {
    const result = [];
    const rightIndex = (0, pipes_1.buildGroupsMap)({
        tableData: right,
        groupBy: using,
    });
    left.forEach(leftRow => {
        const values = using.map(column => leftRow[column]);
        const rightRows = values.reduce((groupMapOrRows, value) => groupMapOrRows.get(value), rightIndex);
        if (!(rightRows === null || rightRows === void 0 ? void 0 : rightRows.length)) {
            result.push(leftRow);
            return;
        }
        rightRows.forEach(rightRow => {
            result.push({
                ...leftRow,
                ...rightRow,
            });
        });
    });
    return result;
};
exports.leftJoin = leftJoin;
const rightJoin = ({ left, right, using }) => {
    return (0, exports.leftJoin)({
        left: right,
        right: left,
        using,
    });
};
exports.rightJoin = rightJoin;
const innerJoin = ({ left, right, using }) => {
    const result = [];
    left.forEach(leftRow => {
        right.forEach(rightRow => {
            if (!(using === null || using === void 0 ? void 0 : using.length)
                || using.every(column => leftRow[column] === rightRow[column])) {
                result.push({
                    ...leftRow,
                    ...rightRow,
                });
            }
        });
    });
    return result;
};
exports.innerJoin = innerJoin;
const crossJoin = ({ left, right }) => {
    return (0, exports.innerJoin)({
        left,
        right,
    });
};
exports.crossJoin = crossJoin;
