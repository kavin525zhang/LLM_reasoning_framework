"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildGroupsMap = exports.group = void 0;
const utils_1 = require("../utils");
const select_1 = require("./select");
const group = ({ groupBy, source }) => {
    return (tableData) => {
        if (!(groupBy === null || groupBy === void 0 ? void 0 : groupBy.length)) {
            return [{
                    by: {},
                    rows: tableData,
                }];
        }
        const groupMap = (0, exports.buildGroupsMap)({
            tableData,
            groupBy,
            source,
        });
        const grouped = traverseToGrouped({
            groupMapOrRows: groupMap,
            groupBy,
        });
        return grouped;
    };
};
exports.group = group;
const buildGroupsMap = ({ tableData, groupBy, source = tableData }) => {
    const groupMap = new utils_1.OrderedMap();
    tableData.forEach(row => {
        let currentMap = groupMap;
        groupBy.forEach((column, index) => {
            const value = (0, select_1.evaluateRowColumnValue)({
                row,
                source,
                column: { column },
            });
            if (index === groupBy.length - 1) {
                if (!currentMap.has(value)) {
                    currentMap.set(value, []);
                }
                const rows = currentMap.get(value);
                rows.push(row);
            }
            else {
                if (!currentMap.has(value)) {
                    currentMap.set(value, new utils_1.OrderedMap());
                }
                currentMap = currentMap.get(value);
            }
        });
    });
    return groupMap;
};
exports.buildGroupsMap = buildGroupsMap;
const traverseToGrouped = (params) => {
    const { groupMapOrRows, groupBy, grouped = [], depth = 0, by = {}, } = params;
    if (depth === groupBy.length) {
        const rows = groupMapOrRows;
        grouped.push({
            by,
            rows,
        });
        return grouped;
    }
    const column = groupBy[depth];
    const groupMap = groupMapOrRows;
    groupMap.forEach((mapOrList, value) => {
        const columnConfig = { column };
        by[(0, select_1.getColumnIdentityName)(columnConfig)] = value;
        traverseToGrouped({
            groupMapOrRows: mapOrList,
            groupBy,
            depth: depth + 1,
            by: { ...by },
            grouped,
        });
    });
    return grouped;
};
