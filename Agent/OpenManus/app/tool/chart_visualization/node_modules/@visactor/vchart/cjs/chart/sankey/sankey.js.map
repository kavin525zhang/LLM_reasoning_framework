{"version":3,"sources":["../src/chart/sankey/sankey.ts"],"names":[],"mappings":"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","file":"sankey.js","sourcesContent":["import { BaseChart } from '../base/base-chart';\nimport { ChartTypeEnum } from '../interface/type';\nimport { SeriesTypeEnum } from '../../series/interface/type';\nimport type { ISankeyChartSpec } from './interface';\nimport { registerSankeySeries } from '../../series/sankey/sankey';\nimport { Factory } from '../../core/factory';\nimport { SankeyChartSpecTransformer } from './sankey-transformer';\nimport type { Datum, MaybeArray } from '../../typings/common';\nimport type { ISeries } from '../../series/interface';\nimport type { IMark } from '../../mark/interface/common';\nimport type { IRegionQuerier } from '../../typings/params';\nimport { isArray, isFunction } from '@visactor/vutils';\nimport { loadScrollbar } from '@visactor/vrender-components';\n\nexport class SankeyChart<T extends ISankeyChartSpec = ISankeyChartSpec> extends BaseChart<T> {\n  static readonly type: string = ChartTypeEnum.sankey;\n  static readonly seriesType: string = SeriesTypeEnum.sankey;\n  static readonly transformerConstructor = SankeyChartSpecTransformer;\n  readonly transformerConstructor = SankeyChartSpecTransformer;\n  readonly type: string = ChartTypeEnum.sankey;\n  readonly seriesType: string = SeriesTypeEnum.sankey;\n\n  protected _setStateInDatum(\n    stateKey: string,\n    checkReverse: boolean,\n    datum: MaybeArray<Datum> | null,\n    filter?: (series: ISeries, mark: IMark) => boolean,\n    region?: IRegionQuerier\n  ) {\n    // 桑基图暂时只支持单选\n    const activeDatum = isArray(datum) ? datum[0] : datum;\n    const keys = !activeDatum ? null : Object.keys(activeDatum);\n    this.getRegionsInQuerier(region).forEach(r => {\n      if (!activeDatum) {\n        r.interaction.clearEventElement(stateKey, true);\n        return;\n      }\n      let hasPick = false;\n      r.getSeries().forEach(s => {\n        let activeNodeOrLink = null;\n\n        s.getMarksWithoutRoot().forEach(m => {\n          if (m.type === 'text') {\n            return;\n          }\n\n          let pickElement = null;\n          const mark = m.getProduct();\n          if (!mark) {\n            return;\n          }\n          if (!filter || (isFunction(filter) && filter(s, m))) {\n            pickElement = mark.elements.find((e: any) =>\n              keys.every(k => {\n                let datum = e.getDatum()?.datum;\n\n                if (isArray(datum)) {\n                  // data of link\n                  datum = datum[0];\n                }\n\n                // eslint-disable-next-line eqeqeq\n                return activeDatum[k] == datum?.[k];\n              })\n            );\n          }\n          if (pickElement) {\n            hasPick = true;\n            r.interaction.startInteraction(stateKey, pickElement);\n\n            if (mark.id().includes('node') || mark.id().includes('link')) {\n              activeNodeOrLink = pickElement;\n            }\n          }\n        });\n\n        if (activeNodeOrLink) {\n          (s as any)._handleEmphasisElement?.({ item: activeNodeOrLink });\n        }\n      });\n      if (checkReverse && hasPick) {\n        r.interaction.reverseEventElement(stateKey);\n      }\n    });\n  }\n}\n\nexport const registerSankeyChart = () => {\n  loadScrollbar();\n  registerSankeySeries();\n\n  Factory.registerChart(SankeyChart.type, SankeyChart);\n};\n"]}