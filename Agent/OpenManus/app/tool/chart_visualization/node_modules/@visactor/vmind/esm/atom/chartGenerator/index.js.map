{"version":3,"sources":["../src/atom/chartGenerator/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @todo @666haiwen optimize and expand with old develop branch feat/v1_develop\n */\n/* eslint-disable @typescript-eslint/no-explicit-any */\nimport type { ChartGeneratorCtx } from '../../types/atom';\nimport { AtomName } from '../../types/atom';\nimport type { ChartGeneratorOptions } from '../type';\nimport { BaseAtom } from '../base';\nimport { merge } from '@visactor/vutils';\nimport type { LLMMessage } from '../../types/llm';\nimport { DEFAULT_MAP_OPTION, SUPPORTED_CHART_LIST } from './const';\nimport { getPrompt, revisedUserInput } from './prompt';\nimport { getContextAfterRevised } from './llmResultRevise';\nimport { checkChartTypeAndCell, getVizSchema } from './utils';\nimport { getChartSpecWithContext } from './spec';\nimport { getRuleLLMContent } from './spec/rule';\nimport { getCellContextByAdvisor } from './advisor';\nimport type { ChartType } from '../../types';\nimport type { GenerateChartCellContext } from './type';\nimport { getFieldInfoFromDataset } from '../../utils/field';\n\nexport class ChartGeneratorAtom extends BaseAtom<ChartGeneratorCtx, ChartGeneratorOptions> {\n  name = AtomName.CHART_GENERATE;\n\n  isLLMAtom = true;\n\n  useRule = false;\n\n  useChartAdvisor: boolean;\n\n  finalChartTypeList: ChartType[];\n\n  constructor(context: ChartGeneratorCtx, option: ChartGeneratorOptions) {\n    super(context, option);\n    this.setFinalChartTypeList();\n  }\n\n  setFinalChartTypeList() {\n    const { chartTypeList, unsupportChartTypeList } = this.options;\n    this.finalChartTypeList = chartTypeList.filter(v => !unsupportChartTypeList.includes(v));\n  }\n\n  buildDefaultContext(context: ChartGeneratorCtx): ChartGeneratorCtx {\n    return merge(\n      {},\n      {\n        dataTable: [],\n        fieldInfo: []\n      },\n      context\n    );\n  }\n\n  buildDefaultOptions(): ChartGeneratorOptions {\n    return {\n      ...super.buildDefaultOptions(),\n      useChartAdvisor: false,\n      chartTypeList: SUPPORTED_CHART_LIST,\n      basemapOption: DEFAULT_MAP_OPTION,\n      unsupportChartTypeList: [],\n      useChartRule: false\n    };\n  }\n\n  updateContext(context: Partial<ChartGeneratorCtx>) {\n    this.context = super.updateContext(context);\n    this.context.vizSchema = getVizSchema(this.context);\n    return this.context;\n  }\n\n  updateOptions(options: ChartGeneratorOptions): void {\n    super.updateOptions(options);\n    this.setFinalChartTypeList();\n  }\n\n  getLLMMessages(query?: string): LLMMessage[] {\n    const { command } = this.context;\n    const { showThoughts } = this.options;\n    const addtionContent = this.getHistoryLLMMessages(query);\n    return [\n      {\n        role: 'system',\n        content: getPrompt(this.finalChartTypeList, showThoughts)\n      },\n      {\n        role: 'user',\n        content: revisedUserInput(command, this.context.vizSchema)\n      },\n      ...addtionContent\n    ];\n  }\n\n  parseLLMContent(resJson: any) {\n    const { CHART_TYPE, FIELD_MAP, thoughts, stackOrPercent, transpose } = resJson;\n    let newContext: GenerateChartCellContext = {\n      ...this.context,\n      thoughts,\n      chartType: CHART_TYPE,\n      cell: FIELD_MAP,\n      chartTypeList: this.finalChartTypeList,\n      stackOrPercent,\n      transpose\n    };\n    newContext = getContextAfterRevised(newContext);\n    const { error, chartType, fieldInfo, cell } = newContext as any;\n    this.useChartAdvisor = false;\n    if (error || !checkChartTypeAndCell(chartType, cell, fieldInfo)) {\n      console.warn('LLM generation error, use rule generation.');\n      this.useChartAdvisor = true;\n      delete (newContext as any).error;\n      delete (newContext as any).message;\n    }\n    return newContext;\n  }\n\n  protected runBeforeLLM(): ChartGeneratorCtx {\n    const { dataTable, fieldInfo } = this.context;\n    this.useRule = false;\n    if (this.options.useChartAdvisor) {\n      this.isLLMAtom = false;\n    }\n    if (!fieldInfo || fieldInfo.length === 0) {\n      this.updateContext({\n        fieldInfo: getFieldInfoFromDataset(dataTable)\n      });\n    }\n    if (dataTable.length > 1 || !this.options.useChartRule) {\n      return this.context;\n    }\n    this.isLLMAtom = false;\n    this.useRule = true;\n    const ruleResJson = getRuleLLMContent(this.context);\n    if (ruleResJson) {\n      this.updateContext(this.parseLLMContent(ruleResJson));\n    } else {\n      this.updateContext({\n        cell: null\n      } as any);\n    }\n    return this.context;\n  }\n\n  protected runWithLLMError(error: string): ChartGeneratorCtx {\n    super._runWithOutLLM();\n    this.useChartAdvisor = true;\n    return this._runWithOutLLM();\n  }\n\n  protected _runWithOutLLM(): ChartGeneratorCtx {\n    this.isLLMAtom = true;\n    if (this.useRule && !this.context.cell) {\n      /** use table */\n      this.context.spec = null;\n      return this.context;\n    }\n    const additionalCtx = {\n      chartTypeList: this.finalChartTypeList,\n      basemapOption: this.options?.basemapOption,\n      totalTime: this.options?.animationDuration,\n      colors: this.options?.colorPalette,\n      chartTheme: this.options?.theme\n    };\n    if (!this.useRule && (this.useChartAdvisor || this.options.useChartAdvisor)) {\n      // @todo\n      const { cell, dataset, chartType, advisedList, usage } = getCellContextByAdvisor({\n        ...this.context,\n        ...additionalCtx\n      });\n      this.context = {\n        ...this.context,\n        usage,\n        cell,\n        dataTable: dataset,\n        chartType,\n        chartAdvistorRes: advisedList.map(item => {\n          const tmpContext = merge({}, this.context, {\n            cell: item.cell,\n            dataTable: item.dataset,\n            chartType: item.chartType\n          });\n          return {\n            chartType: item.chartType as ChartType,\n            score: item.score,\n            spec: getChartSpecWithContext({ ...tmpContext, ...additionalCtx }).spec\n          };\n        })\n      };\n    } else {\n      this.context.chartAdvistorRes = [];\n    }\n    const newContext = {\n      ...this.context,\n      ...getChartSpecWithContext({ ...this.context, ...additionalCtx })\n    };\n    this.updateContext(newContext);\n    return newContext;\n  }\n}\n"]}