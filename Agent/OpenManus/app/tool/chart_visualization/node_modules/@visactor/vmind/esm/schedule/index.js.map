{"version":3,"sources":["../src/schedule/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { merge } from '@visactor/vutils';\nimport type { BaseContext, Usage } from '../types/atom';\nimport { AtomName } from '../types/atom';\nimport { BaseAtom } from '../atom/base';\nimport {\n  DataQueryAtom,\n  DataExtractionAtom,\n  ChartGeneratorAtom,\n  ChartCommandAtom,\n  DataInsightAtom,\n  MultipleDataCleanAtom,\n  MultipleChartCommandAtom,\n  CustomPrompt,\n  ChartQAExtraction,\n  VChartSpec,\n  SpecInsightAtom\n} from '../atom';\nimport type { CombineAll, MapAtomTypes, TaskMapping } from '../types/schedule';\nimport { DataCleanAtom } from '../atom/dataClean/dataClean';\nimport type {\n  BaseOptions,\n  ChartCommandOptions,\n  ChartGeneratorOptions,\n  DataCleanOptions,\n  DataExtractionOptions,\n  DataInsightOptions,\n  CustomPromptOptions,\n  SpecInsightOptions\n} from '../atom/type';\n\nexport interface ScheduleOptions {\n  [AtomName.BASE]?: BaseOptions;\n  [AtomName.DATA_EXTRACT]?: DataExtractionOptions;\n  [AtomName.DATA_CLEAN]?: DataCleanOptions;\n  [AtomName.MULTIPLE_DATA_CLEAN]?: DataCleanOptions;\n  [AtomName.DATA_QUERY]?: BaseOptions;\n  [AtomName.DATA_INSIGHT]?: DataInsightOptions;\n  [AtomName.SPEC_INSIGHT]?: SpecInsightOptions;\n  [AtomName.CHART_GENERATE]?: ChartGeneratorOptions;\n  [AtomName.CHART_COMMAND]?: ChartCommandOptions;\n  [AtomName.MULTIPLE_CHART_COMMAND]?: ChartCommandOptions;\n  [AtomName.CHART_QA_EXTRACTION]?: BaseOptions;\n  [AtomName.CUSTOM_PROMPT]?: CustomPromptOptions;\n  [AtomName.VCHART_SPEC]?: BaseOptions;\n}\n\nexport class Schedule<T extends AtomName[]> {\n  atomInstaces: (\n    | DataExtractionAtom\n    | DataCleanAtom\n    | DataQueryAtom\n    | ChartGeneratorAtom\n    | BaseAtom<BaseContext, BaseOptions>\n  )[];\n\n  atomList: AtomName[];\n\n  private context: any;\n\n  options: ScheduleOptions;\n\n  /** current query */\n  protected query: string;\n\n  /** @todo */\n  historySteps: any;\n\n  constructor(atomList: T, options?: ScheduleOptions, context?: CombineAll<MapAtomTypes<T>>) {\n    this.atomList = atomList;\n    this.options = options || {};\n    this.query = '';\n    this.atomInstaces = atomList.map(atomName => this.atomFactory(atomName));\n    this.setNewTask(context);\n  }\n\n  initContext() {\n    this.context = {} as T;\n    this.atomInstaces.forEach(atom => {\n      this.context = atom.buildDefaultContext(this.context);\n      atom.reset();\n    });\n  }\n\n  getAtomOptions(atomName: AtomName) {\n    return merge({}, this.options[AtomName.BASE], this.options[atomName]);\n  }\n\n  atomFactory(atomName: AtomName) {\n    const options = this.getAtomOptions(atomName);\n    switch (atomName) {\n      case AtomName.DATA_EXTRACT:\n        return new DataExtractionAtom(this.context, options);\n      case AtomName.DATA_CLEAN:\n        return new DataCleanAtom(this.context, options);\n      case AtomName.MULTIPLE_DATA_CLEAN:\n        return new MultipleDataCleanAtom(this.context, options);\n      case AtomName.DATA_QUERY:\n        return new DataQueryAtom(this.context, options);\n      case AtomName.DATA_INSIGHT:\n        return new DataInsightAtom(this.context, options);\n      case AtomName.SPEC_INSIGHT:\n        return new SpecInsightAtom(this.context, options);\n      case AtomName.CHART_COMMAND:\n        return new ChartCommandAtom(this.context, options);\n      case AtomName.MULTIPLE_CHART_COMMAND:\n        return new MultipleChartCommandAtom(this.context, options);\n      case AtomName.CHART_GENERATE:\n        return new ChartGeneratorAtom(this.context, options);\n      case AtomName.CHART_QA_EXTRACTION:\n        return new ChartQAExtraction(this.context, options);\n      case AtomName.CUSTOM_PROMPT:\n        return new CustomPrompt(this.context, options);\n      case AtomName.VCHART_SPEC:\n        return new VChartSpec(this.context, options);\n      default:\n        return new BaseAtom(this.context, options);\n    }\n  }\n\n  /** regonize user intention and parse as sub tasks to atom instances */\n  private parseSubTasks(query?: string): TaskMapping {\n    /** @todo */\n    let taskMapping: TaskMapping = {};\n    this.atomList.forEach(name => {\n      taskMapping = {\n        ...taskMapping,\n        [name]: {\n          shouldRun: true,\n          query\n        }\n      };\n    });\n    return taskMapping;\n  }\n\n  private addUsage(oldUsage: Usage, newUsage?: Usage): Usage {\n    const result: Usage = {} as Usage;\n    if (!newUsage) {\n      return oldUsage;\n    }\n    for (const key in oldUsage) {\n      if (Object.prototype.hasOwnProperty.call(oldUsage, key)) {\n        const curKey = key as keyof Usage;\n        result[curKey] = (oldUsage[curKey] || 0) + (newUsage?.[curKey] || 0);\n      }\n    }\n\n    return result;\n  }\n\n  async run(query?: string, shouldRunList?: Record<AtomName, boolean>): Promise<Awaited<CombineAll<MapAtomTypes<T>>>> {\n    this.query = query || '';\n    const subTasks = this.parseSubTasks(query);\n    let usage: Usage = {\n      prompt_tokens: 0,\n      completion_tokens: 0,\n      total_tokens: 0\n    };\n    for (const atom of this.atomInstaces) {\n      const { shouldRun, query: taskQuery } = subTasks?.[atom.name] || {};\n      if (shouldRunList?.[atom.name] !== false && (shouldRun || atom.shouldRunByContextUpdate(this.context))) {\n        this.context = await atom.run({ context: this.context, query: taskQuery });\n        usage = this.addUsage(usage, atom.getContext()?.usage);\n      }\n    }\n    this.context = {\n      ...this.context,\n      usage: usage\n    };\n    return this.context;\n  }\n\n  /** init new task ready to run new query */\n  setNewTask(context: any) {\n    this.initContext();\n    this.updateContext(context);\n    this.atomInstaces.forEach(atom => {\n      atom.reset(this.context);\n      atom.clearHistory();\n    });\n  }\n\n  updateOptions(options: ScheduleOptions) {\n    this.options = merge({}, this.options, options);\n    this.atomInstaces.forEach(atom => atom.updateOptions(this.getAtomOptions(atom.name)));\n  }\n\n  updateContext(context: any, isReplace = false) {\n    this.context = isReplace ? context : merge({}, this.context, context);\n  }\n\n  /**\n   * get schedule context or specific context of atom\n   * @param atomName name of atom(optional)\n   * @returns context\n   */\n  getContext(atomName?: AtomName): CombineAll<MapAtomTypes<T>> {\n    if (atomName) {\n      const atomInstaces = this.atomInstaces.find(atom => atom.name === atomName);\n      if (!atomInstaces) {\n        console.error(`Doesn\\'t exist ${atomName}`);\n        return null as any;\n      }\n      return atomInstaces.getContext() as any;\n    }\n    return this.context;\n  }\n}\n"]}