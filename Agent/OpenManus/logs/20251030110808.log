2025-10-30 11:08:18.040 | INFO     | __main__:initialize:26 - Initializing MCPAgent with sse connection...
2025-10-30 11:08:18.114 | INFO     | app.tool.mcp:_initialize_and_list_tools:124 - Connected to server http://172.18.140.24:9527/sse with tools: ['DKM全文检索接口', 'DKM向量搜索接口', '根据文档Id获取文档分片内容']
2025-10-30 11:08:18.127 | INFO     | app.agent.mcp:_refresh_tools:122 - Added MCP tools: ['DKM全文检索接口', 'DKM向量搜索接口', '根据文档Id获取文档分片内容']
2025-10-30 11:08:18.127 | INFO     | __main__:initialize:37 - Connected to MCP server via sse
2025-10-30 11:09:07.434 | WARNING  | __main__:run_default:60 - Processing your request...
2025-10-30 11:09:07.434 | INFO     | app.agent.base:run:141 - Executing step 1/20
2025-10-30 11:09:08.925 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:08.925 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:11.332 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:11.332 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:13.888 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:13.889 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:17.172 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:17.172 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:19.755 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:19.755 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:36.770 | ERROR    | app.llm:ask_tool:757 - OpenAI API error: Connection error.
2025-10-30 11:09:36.770 | ERROR    | app.llm:ask_tool:763 - API error: Connection error.
2025-10-30 11:09:36.771 | INFO     | app.tool.mcp:disconnect:185 - Disconnected from MCP server http://172.18.140.24:9527/sse
2025-10-30 11:09:36.772 | INFO     | app.tool.mcp:disconnect:194 - Disconnected from all MCP servers
2025-10-30 11:09:36.772 | INFO     | app.agent.mcp:cleanup:180 - MCP connection closed
2025-10-30 11:09:36.795 | ERROR    | __main__:run_mcp:110 - eeee:Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions
    yield
  File "/usr/local/lib/python3.12/site-packages/httpx/_transports/default.py", line 394, in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpcore/_async/connection_pool.py", line 256, in handle_async_request
    raise exc from None
  File "/usr/local/lib/python3.12/site-packages/httpcore/_async/connection_pool.py", line 236, in handle_async_request
    response = await connection.handle_async_request(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpcore/_async/connection.py", line 101, in handle_async_request
    raise exc
  File "/usr/local/lib/python3.12/site-packages/httpcore/_async/connection.py", line 78, in handle_async_request
    stream = await self._connect(request)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpcore/_async/connection.py", line 124, in _connect
    stream = await self._network_backend.connect_tcp(**kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpcore/_backends/auto.py", line 31, in connect_tcp
    return await self._backend.connect_tcp(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpcore/_backends/anyio.py", line 113, in connect_tcp
    with map_exceptions(exc_map):
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/usr/local/lib/python3.12/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions
    raise to_exc(exc) from exc
httpcore.ConnectError: All connection attempts failed

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1500, in _request
    response = await self._client.send(
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    response = await self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    response = await self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/httpx/_transports/default.py", line 393, in handle_async_request
    with map_httpcore_exceptions():
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/usr/local/lib/python3.12/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions
    raise mapped_exc(message) from exc
httpx.ConnectError: All connection attempts failed

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 114, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/llm.py", line 734, in ask_tool
    response: ChatCompletion = await self.client.chat.completions.create(
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2000, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1524, in _request
    return await self._retry_request(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1594, in _retry_request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1524, in _request
    return await self._retry_request(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1594, in _retry_request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/openai/_base_client.py", line 1534, in _request
    raise APIConnectionError(request=request) from err
openai.APIConnectionError: Connection error.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/run_mcp.py", line 105, in run_mcp
    await runner.run_default()
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/run_mcp.py", line 61, in run_default
    await self.agent.run(prompt)
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/mcp.py", line 185, in run
    result = await super().run(request)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/toolcall.py", line 260, in run
    return await super().run(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/base.py", line 142, in run
    step_result = await self.step()
                  ^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/react.py", line 35, in step
    should_act = await self.think()
                 ^^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/mcp.py", line 156, in think
    return await super().think()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/transwarp/Documents/workspace/private/LLM_reasoning_framework/Agent/OpenManus/app/agent/toolcall.py", line 52, in think
    response = await self.llm.ask_tool(
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 189, in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 111, in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 153, in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/tenacity/_utils.py", line 99, in inner
    return call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/tenacity/__init__.py", line 419, in exc_check
    raise retry_exc from fut.exception()
tenacity.RetryError: RetryError[<Future at 0x7ff0318c5910 state=finished raised APIConnectionError>]

2025-10-30 11:09:36.798 | ERROR    | __main__:run_mcp:111 - Error running MCPAgent: RetryError[<Future at 0x7ff0318c5910 state=finished raised APIConnectionError>]
2025-10-30 11:09:36.798 | INFO     | __main__:cleanup:67 - Session ended
